# ============================================================================
# Kind 로컬 테스트 클러스터 설정 파일
# ============================================================================
#
# Kind (Kubernetes IN Docker)란?
# - Docker 컨테이너 내부에서 Kubernetes 클러스터를 실행하는 도구
# - 로컬 개발 및 테스트에 최적화됨
# - 실제 프로덕션 환경과 유사한 멀티 노드 구성 가능
#
# 이 파일의 목적:
# - 학습 및 로컬 테스트를 위한 경량 클러스터 구성
# - Ingress 컨트롤러 사용을 위한 포트 매핑 설정
# - 실제 운영 환경을 시뮬레이션하는 멀티 노드 구성
#
# ============================================================================

kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4

# 클러스터 이름 지정
# kubectl config get-contexts 명령으로 확인 가능
name: local-test-cluster

# ============================================================================
# 노드 구성 (Multi-node Setup)
# ============================================================================
#
# 왜 멀티 노드로 구성하나요?
# 1. Pod 스케줄링 학습: 여러 노드에 분산 배치되는 것을 확인
# 2. 노드 장애 시뮬레이션: 특정 노드를 중지하여 고가용성 테스트
# 3. Affinity/Anti-affinity 학습: Pod를 특정 노드에 배치하는 전략 테스트
# 4. 실제 환경 시뮬레이션: 프로덕션 환경과 유사한 구조
#
# ============================================================================

nodes:
  # ----------------------------------------------------------------------------
  # Control Plane (Master) 노드
  # ----------------------------------------------------------------------------
  # 역할: 클러스터 관리, API 서버, 스케줄러, etcd 실행
  #
  # Control Plane이 하는 일:
  # - API 서버: kubectl 명령을 받아 처리
  # - 스케줄러: Pod를 어느 노드에 배치할지 결정
  # - Controller Manager: Deployment, ReplicaSet 등 리소스 관리
  # - etcd: 클러스터의 모든 데이터를 저장하는 Key-Value 저장소
  # ----------------------------------------------------------------------------
  - role: control-plane

    # -------------------------------------------------------------------------
    # 포트 매핑 설정
    # -------------------------------------------------------------------------
    # 외부(호스트)에서 클러스터 내부 서비스에 접근하기 위한 설정
    #
    # 포트 매핑이 필요한 이유:
    # - Kind 클러스터는 Docker 컨테이너 안에서 실행됨
    # - 기본적으로 호스트에서 클러스터 내부 서비스에 직접 접근 불가
    # - 포트 매핑으로 호스트 포트 -> 컨테이너 포트 연결
    # -------------------------------------------------------------------------
    extraPortMappings:
      # HTTP 트래픽용 (Ingress Controller)
      # - containerPort: 컨테이너(노드) 내부 포트
      # - hostPort: 호스트(내 PC) 포트
      # - listenAddress: 바인딩 주소 (0.0.0.0 = 모든 네트워크 인터페이스)
      #
      # 사용 예: http://localhost:80 접속 시 -> Ingress Controller로 라우팅
      - containerPort: 80
        hostPort: 80
        protocol: TCP
        listenAddress: "0.0.0.0"

      # HTTPS 트래픽용 (Ingress Controller - TLS)
      # 사용 예: https://localhost:443 접속 시 -> Ingress Controller로 라우팅
      - containerPort: 443
        hostPort: 443
        protocol: TCP
        listenAddress: "0.0.0.0"

      # Spring Boot 애플리케이션 직접 접근용 (선택사항)
      # NodePort 서비스를 사용하여 직접 접근할 때 사용
      # 사용 예: http://localhost:8082 접속 시 -> Spring Boot 앱으로 라우팅
      - containerPort: 8082
        hostPort: 8082
        protocol: TCP
        listenAddress: "0.0.0.0"

      # NodePort 범위 (Kubernetes 기본 NodePort 범위: 30000-32767)
      # NodePort 서비스 타입 사용 시 이 범위의 포트가 자동 할당됨
      # 사용 예: Service에서 nodePort: 30080 지정 시 localhost:30080으로 접근
      - containerPort: 30080
        hostPort: 30080
        protocol: TCP

      - containerPort: 30443
        hostPort: 30443
        protocol: TCP

    # -------------------------------------------------------------------------
    # Kubeadm 설정 패치 (고급 설정)
    # -------------------------------------------------------------------------
    # Ingress Controller가 Control Plane 노드에서도 실행되도록 허용
    #
    # 기본적으로 Control Plane 노드에는 Taint가 설정되어 있어
    # 일반 Pod가 스케줄링되지 않음 (관리 작업만 수행)
    #
    # Ingress Controller는 네트워크 진입점이므로
    # Control Plane 노드에서도 실행되도록 Taint 제거
    #
    # 참고: 단일 노드 클러스터나 테스트 환경에서 유용
    # -------------------------------------------------------------------------
    kubeadmConfigPatches:
      - |
        kind: InitConfiguration
        nodeRegistration:
          kubeletExtraArgs:
            # 노드에 Pod 배치를 허용 (Control Plane도 워크로드 실행 가능)
            node-labels: "ingress-ready=true"

    # 노드 레이블 추가 (Pod 스케줄링 시 선택 기준으로 사용)
    # 레이블을 사용하여 특정 노드에 Pod를 배치할 수 있음
    labels:
      node-type: master
      environment: local-test
      ingress-ready: "true"

  # ----------------------------------------------------------------------------
  # Worker 노드 1
  # ----------------------------------------------------------------------------
  # 역할: 실제 애플리케이션 Pod가 실행되는 노드
  #
  # Worker 노드가 하는 일:
  # - kubelet: Control Plane의 명령을 받아 Pod 실행/관리
  # - kube-proxy: 네트워크 규칙 관리, Service 라우팅
  # - Container Runtime: 실제 컨테이너 실행 (Docker, containerd 등)
  # ----------------------------------------------------------------------------
  - role: worker
    labels:
      node-type: worker
      worker-id: "1"
      environment: local-test
      # 특정 워크로드 전용 노드로 지정 가능
      workload-type: application

  # ----------------------------------------------------------------------------
  # Worker 노드 2
  # ----------------------------------------------------------------------------
  # 두 번째 워커 노드를 추가하여 Pod 분산 배치 학습
  # 고가용성(HA) 시뮬레이션: 하나의 노드가 다운되어도 서비스 계속 제공
  # ----------------------------------------------------------------------------
  - role: worker
    labels:
      node-type: worker
      worker-id: "2"
      environment: local-test
      workload-type: application

# ============================================================================
# 네트워킹 설정
# ============================================================================
#
# Kubernetes 클러스터 네트워크 구성
#
# Pod Network (Pod CIDR):
# - 클러스터 내부 Pod들이 사용하는 IP 대역
# - 각 Pod는 이 대역에서 고유한 IP를 할당받음
# - 노드 간 Pod 통신에 사용
#
# Service Network (Service CIDR):
# - Service 리소스가 사용하는 가상 IP 대역
# - ClusterIP 타입 Service는 이 대역에서 IP 할당
# - kube-proxy가 이 IP로의 트래픽을 실제 Pod로 라우팅
#
# 참고: 이 IP 대역은 클러스터 내부에서만 사용되며, 외부에서 직접 접근 불가
# ============================================================================

networking:
  # Pod 네트워크 대역
  # 기본값: 10.244.0.0/16 (Flannel CNI 기본값과 동일)
  # 약 65,000개의 Pod IP 할당 가능
  podSubnet: "10.244.0.0/16"

  # Service 네트워크 대역
  # 기본값: 10.96.0.0/12
  # 약 1,048,000개의 Service IP 할당 가능
  serviceSubnet: "10.96.0.0/12"

  # DNS 설정 (기본값 사용)
  # Kubernetes는 내부 DNS 서비스를 제공
  # Service 이름으로 다른 Pod에 접근 가능
  # 예: http://my-service.default.svc.cluster.local

# ============================================================================
# Feature Gates (선택사항)
# ============================================================================
#
# Kubernetes의 실험적 기능이나 베타 기능을 활성화
#
# 학습 목적으로 유용한 Feature Gates:
# - EphemeralContainers: 디버깅용 임시 컨테이너 실행
# - HPAScaleToZero: HPA로 Pod를 0개까지 축소 가능
# - ServerSideApply: kubectl apply의 서버사이드 처리
#
# 참고: 프로덕션에서는 안정화된 기능만 사용 권장
# ============================================================================

# featureGates:
#   # 디버깅용 임시 컨테이너 활성화 (kubectl debug 명령어 사용)
#   "EphemeralContainers": true
#
#   # HPA가 Pod를 0개까지 축소 가능 (비용 절감)
#   "HPAScaleToZero": true

# ============================================================================
# 추가 설정 (Runtime Config)
# ============================================================================
#
# Kubernetes API 서버의 추가 설정
# 특정 API 버전 활성화/비활성화 가능
# ============================================================================

# kubeadmConfigPatches:
#   - |
#     kind: ClusterConfiguration
#     apiServer:
#       extraArgs:
#         # API 서버 로그 레벨 (0-10, 숫자가 클수록 상세)
#         v: "4"
#         # 감사 로그 활성화 (API 호출 기록)
#         audit-log-path: "/var/log/kubernetes/audit.log"

# ============================================================================
# 사용 방법
# ============================================================================
#
# 1. 클러스터 생성:
#    kind create cluster --config=kind-local-test-config.yaml
#
# 2. 클러스터 확인:
#    kubectl cluster-info --context kind-local-test-cluster
#    kubectl get nodes
#
# 3. 클러스터 삭제:
#    kind delete cluster --name local-test-cluster
#
# 4. 노드 상태 확인:
#    kubectl get nodes -o wide
#    kubectl describe node local-test-cluster-control-plane
#
# 5. 포트 매핑 확인:
#    docker ps (Kind 컨테이너의 포트 매핑 확인)
#
# ============================================================================

# ============================================================================
# 학습 체크리스트
# ============================================================================
#
# □ Control Plane과 Worker 노드의 역할 차이를 이해했나요?
# □ 포트 매핑이 왜 필요한지 이해했나요?
# □ Pod Network와 Service Network의 차이를 알고 있나요?
# □ 노드 레이블을 사용하여 Pod를 특정 노드에 배치할 수 있나요?
# □ Ingress Controller가 어떻게 트래픽을 라우팅하는지 이해했나요?
#
# ============================================================================
