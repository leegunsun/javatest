# ============================================================================
# Kustomization Configuration for Spring Boot Application
# ============================================================================
# Kustomize는 Kubernetes 리소스의 선언적 관리를 위한 도구입니다.
# 템플릿 없이 YAML 파일을 조합하고 커스터마이징할 수 있습니다.
#
# 주요 장점:
# 1. 배포 순서 보장 - resources 섹션의 순서대로 리소스가 생성됨
# 2. 공통 설정 적용 - 모든 리소스에 일괄적으로 라벨, 네임스페이스 등을 추가
# 3. 환경별 관리 - base와 overlay 패턴으로 dev/staging/prod 환경 분리
# 4. 네이티브 지원 - kubectl에 내장되어 별도 설치 불필요
#
# 사용 방법:
# 1. 단일 명령어로 모든 리소스 적용:
#    kubectl apply -k k8s/
#    또는
#    kubectl apply -k .  (k8s 디렉토리 내에서)
#
# 2. 적용 전 생성될 매니페스트 미리보기:
#    kubectl kustomize k8s/
#    kustomize build k8s/
#
# 3. 리소스 삭제:
#    kubectl delete -k k8s/
# ============================================================================

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# ----------------------------------------------------------------------------
# Resources: 배포할 Kubernetes 리소스 파일 목록
# ----------------------------------------------------------------------------
# 중요: 나열된 순서대로 리소스가 생성됩니다!
# 의존성 순서를 고려하여 아래와 같이 배치:
#
# 1단계: ConfigMap & Secret (설정 데이터)
#   → Deployment가 참조하기 전에 먼저 생성되어야 함
#
# 2단계: Deployment (애플리케이션 파드)
#   → ConfigMap/Secret이 존재해야 정상 기동
#   → Service가 라우팅할 파드를 생성
#
# 3단계: Service (내부 로드밸런싱)
#   → Deployment가 생성한 파드에 대한 엔드포인트 생성
#   → Ingress가 백엔드로 참조
#
# 4단계: Ingress (외부 트래픽 라우팅)
#   → Service가 존재해야 백엔드 연결 가능
#
# 5단계: HPA (자동 스케일링)
#   → Deployment가 존재해야 스케일링 대상 지정 가능
#   → 메트릭 수집을 위해 파드가 먼저 실행 중이어야 함
# ----------------------------------------------------------------------------
resources:
  # 1단계: 설정 리소스 (Configuration Resources)
  - configmap.yaml       # 애플리케이션 설정 데이터 (application.yml, logback.xml 등)
  - secret.yaml          # 민감 정보 (데이터베이스 비밀번호, API 키 등)

  # 2단계: 워크로드 리소스 (Workload Resources)
  - deployment.yaml      # Spring Boot 애플리케이션 파드 정의 및 배포 전략

  # 3단계: 네트워킹 리소스 (Networking Resources)
  - service.yaml         # ClusterIP/NodePort/LoadBalancer 서비스
  - ingress.yaml         # HTTP/HTTPS 외부 접근 라우팅 규칙

  # 4단계: 스케일링 리소스 (Scaling Resources)
  - hpa.yaml             # CPU/메모리 기반 수평적 파드 자동 스케일링

# ----------------------------------------------------------------------------
# Labels: 모든 리소스에 자동으로 추가될 공통 라벨
# ----------------------------------------------------------------------------
# 장점:
# - 각 리소스 파일마다 중복해서 작성하지 않아도 됨
# - 일관된 라벨링 정책 적용으로 관리 용이
# - kubectl get 명령어로 필터링 및 그룹화 가능
#
# 사용 예시:
#   kubectl get all -l app.kubernetes.io/name=spring-boot-app
#   kubectl get all -l app.kubernetes.io/managed-by=kustomize
#
# 참고: commonLabels는 deprecated되어 labels로 변경됨 (Kustomize v4.5.0+)
# ----------------------------------------------------------------------------
labels:
  - pairs:
      # Kubernetes 권장 라벨 (https://kubernetes.io/docs/concepts/overview/working-with-objects/common-labels/)
      app.kubernetes.io/name: spring-boot-app           # 애플리케이션 이름
      app.kubernetes.io/instance: spring-boot-instance  # 애플리케이션 인스턴스 식별자
      app.kubernetes.io/version: "1.0.0"                # 애플리케이션 버전
      app.kubernetes.io/component: backend              # 아키텍처 내 역할 (backend/frontend/database)
      app.kubernetes.io/part-of: microservices          # 전체 시스템에서의 소속
      app.kubernetes.io/managed-by: kustomize           # 관리 도구

# ----------------------------------------------------------------------------
# Common Annotations: 모든 리소스에 자동으로 추가될 공통 어노테이션
# ----------------------------------------------------------------------------
# 메타데이터 정보를 추가하여 관리 및 모니터링 용이
# ----------------------------------------------------------------------------
commonAnnotations:
  description: "Spring Boot Application deployed with Kustomize"
  team: "backend-team"
  contact: "backend-team@example.com"
  documentation: "https://github.com/your-org/your-repo/blob/main/k8s/README.md"

# ----------------------------------------------------------------------------
# Namespace: 모든 리소스를 배포할 네임스페이스
# ----------------------------------------------------------------------------
# 주의: 네임스페이스는 사전에 생성되어 있어야 합니다.
# 생성 명령어: kubectl create namespace spring-boot-ns
#
# 네임스페이스를 지정하지 않으려면 아래 라인을 주석 처리하세요.
# 주석 처리 시 default 네임스페이스에 배포됩니다.
# ----------------------------------------------------------------------------
namespace: spring-boot-ns

# ----------------------------------------------------------------------------
# Name Prefix/Suffix (선택사항)
# ----------------------------------------------------------------------------
# 모든 리소스 이름에 접두사/접미사를 자동으로 추가할 수 있습니다.
# 같은 네임스페이스에 여러 버전을 배포하거나, 환경별로 구분할 때 유용합니다.
#
# 예시:
# namePrefix: dev-        # dev-spring-boot-app-deployment
# nameSuffix: -v1         # spring-boot-app-deployment-v1
#
# 주의: Ingress의 host, Service의 selector 등에 영향을 줄 수 있으므로
#       필요한 경우에만 사용하세요.
# ----------------------------------------------------------------------------
# namePrefix: ""
# nameSuffix: ""

# ----------------------------------------------------------------------------
# Images: 컨테이너 이미지 이름 및 태그 변경 (선택사항)
# ----------------------------------------------------------------------------
# Deployment의 이미지를 수정하지 않고 런타임에 이미지를 변경할 수 있습니다.
# CI/CD 파이프라인에서 빌드 번호나 Git SHA를 태그로 사용할 때 유용합니다.
#
# 사용 예시:
# images:
#   - name: your-registry/spring-boot-app
#     newName: your-registry/spring-boot-app
#     newTag: v2.0.0
#   - name: your-registry/spring-boot-app
#     newTag: latest
#
# 적용 방법:
# 1. 직접 수정: kustomization.yaml에서 newTag 값 변경
# 2. CLI 사용: kustomize edit set image your-registry/spring-boot-app=your-registry/spring-boot-app:v2.0.0
# ----------------------------------------------------------------------------
# images:
#   - name: your-registry/spring-boot-app
#     newTag: latest

# ----------------------------------------------------------------------------
# Replicas (선택사항)
# ----------------------------------------------------------------------------
# Deployment의 replica 수를 오버라이드할 수 있습니다.
# HPA를 사용하는 경우 HPA가 replica 수를 자동으로 조정하므로
# 이 설정은 초기값으로만 작용합니다.
#
# 사용 예시:
# replicas:
#   - name: spring-boot-app-deployment
#     count: 5
# ----------------------------------------------------------------------------
# replicas:
#   - name: spring-boot-app-deployment
#     count: 3

# ----------------------------------------------------------------------------
# ConfigMap Generator (선택사항)
# ----------------------------------------------------------------------------
# 파일이나 리터럴 값으로부터 ConfigMap을 자동 생성할 수 있습니다.
# 내용이 변경되면 자동으로 해시가 이름에 추가되어 무중단 롤링 업데이트가 가능합니다.
#
# 사용 예시:
# configMapGenerator:
#   - name: app-config
#     files:
#       - configs/application.yml
#       - configs/logback.xml
#     literals:
#       - LOG_LEVEL=INFO
#       - SPRING_PROFILES_ACTIVE=prod
#
# 생성된 ConfigMap 이름: app-config-{hash}
# Deployment에서 참조 시 Kustomize가 자동으로 해시를 추가해줍니다.
# ----------------------------------------------------------------------------
# configMapGenerator:
#   - name: app-config
#     files:
#       - application.yml

# ----------------------------------------------------------------------------
# Secret Generator (선택사항)
# ----------------------------------------------------------------------------
# 파일이나 리터럴 값으로부터 Secret을 자동 생성할 수 있습니다.
# ConfigMap과 동일하게 내용 변경 시 해시가 추가됩니다.
#
# 주의: Secret 값은 base64 인코딩되어 저장됩니다.
#      실제 운영 환경에서는 sealed-secrets, external-secrets 등의
#      보안 솔루션 사용을 권장합니다.
#
# 사용 예시:
# secretGenerator:
#   - name: db-credentials
#     literals:
#       - MYSQL_PASSWORD=your-secure-password
#       - MYSQL_ROOT_PASSWORD=your-root-password
#     files:
#       - tls.crt
#       - tls.key
# ----------------------------------------------------------------------------
# secretGenerator:
#   - name: db-credentials
#     literals:
#       - MYSQL_PASSWORD=changeme

# ----------------------------------------------------------------------------
# Patches (고급 기능)
# ----------------------------------------------------------------------------
# 기존 리소스의 특정 필드를 수정할 수 있습니다.
# Strategic Merge Patch 또는 JSON Patch를 사용합니다.
#
# 사용 예시 1: Strategic Merge Patch
# patchesStrategicMerge:
#   - |-
#     apiVersion: apps/v1
#     kind: Deployment
#     metadata:
#       name: spring-boot-app-deployment
#     spec:
#       replicas: 5
#       template:
#         spec:
#           containers:
#           - name: spring-boot-app
#             resources:
#               limits:
#                 cpu: "2"
#                 memory: "2Gi"
#
# 사용 예시 2: JSON6902 Patch
# patchesJson6902:
#   - target:
#       group: apps
#       version: v1
#       kind: Deployment
#       name: spring-boot-app-deployment
#     patch: |-
#       - op: replace
#         path: /spec/replicas
#         value: 5
# ----------------------------------------------------------------------------

# ============================================================================
# 환경별 설정 (Overlay Pattern)
# ============================================================================
# Kustomize의 강력한 기능 중 하나는 base/overlay 패턴입니다.
#
# 디렉토리 구조 예시:
# k8s/
# ├── base/
# │   ├── kustomization.yaml    # 공통 기본 설정
# │   ├── deployment.yaml
# │   ├── service.yaml
# │   └── ...
# ├── overlays/
# │   ├── dev/
# │   │   ├── kustomization.yaml    # Dev 환경 오버라이드
# │   │   └── patches/
# │   ├── staging/
# │   │   ├── kustomization.yaml    # Staging 환경 오버라이드
# │   │   └── patches/
# │   └── prod/
# │       ├── kustomization.yaml    # Production 환경 오버라이드
# │       └── patches/
#
# 각 overlay의 kustomization.yaml에서 base를 참조:
# bases:
#   - ../../base
#
# 배포 방법:
# kubectl apply -k k8s/overlays/dev/
# kubectl apply -k k8s/overlays/prod/
# ============================================================================

# ============================================================================
# 참고 자료
# ============================================================================
# - Kustomize 공식 문서: https://kustomize.io/
# - Kubernetes 공식 문서: https://kubernetes.io/docs/tasks/manage-kubernetes-objects/kustomization/
# - 권장 라벨: https://kubernetes.io/docs/concepts/overview/working-with-objects/common-labels/
# - Kustomize GitHub: https://github.com/kubernetes-sigs/kustomize
# ============================================================================
