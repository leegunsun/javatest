# ============================================================================
# ingress.yaml - AWS ALB Ingress Controller 설정
# ============================================================================
#
# AWS ALB Ingress Controller란?
# - AWS Application Load Balancer를 Kubernetes Ingress로 사용
# - Ingress 리소스 생성 시 자동으로 ALB가 프로비저닝됨
# - L7 로드밸런싱이 AWS ALB에서 직접 처리 (L7 중복 없음)
#
# 트래픽 흐름:
#   Route53 -> ALB (L7) -> Service (L4) -> Pod
#   또는 target-type: ip 사용 시:
#   Route53 -> ALB (L7) -> Pod (직접)
#
# 사전 요구사항:
# 1. AWS Load Balancer Controller 설치
# 2. IAM 정책 및 서비스 계정 구성
# 3. 서브넷 태깅 (kubernetes.io/cluster/<cluster-name>)
#
# ============================================================================

# ============================================================================
# AWS Load Balancer Controller 설치 방법
# ============================================================================
#
# 1. IAM 정책 생성:
#    curl -o iam_policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.7.0/docs/install/iam_policy.json
#    aws iam create-policy \
#      --policy-name AWSLoadBalancerControllerIAMPolicy \
#      --policy-document file://iam_policy.json
#
# 2. 서비스 계정 생성 (eksctl 사용):
#    eksctl create iamserviceaccount \
#      --cluster=<cluster-name> \
#      --namespace=kube-system \
#      --name=aws-load-balancer-controller \
#      --attach-policy-arn=arn:aws:iam::<account-id>:policy/AWSLoadBalancerControllerIAMPolicy \
#      --approve
#
# 3. Helm으로 Controller 설치:
#    helm repo add eks https://aws.github.io/eks-charts
#    helm repo update
#    helm install aws-load-balancer-controller eks/aws-load-balancer-controller \
#      -n kube-system \
#      --set clusterName=<cluster-name> \
#      --set serviceAccount.create=false \
#      --set serviceAccount.name=aws-load-balancer-controller
#
# 4. 설치 확인:
#    kubectl get deployment -n kube-system aws-load-balancer-controller
#
# ============================================================================

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: open-green-ingress
  namespace: default
  labels:
    app: open-green

  annotations:
    # ==========================================================================
    # AWS ALB Ingress Controller 필수 설정
    # ==========================================================================

    # Ingress 클래스 지정 (ALB 사용)
    kubernetes.io/ingress.class: alb

    # ALB 스킴: internet-facing (외부) 또는 internal (내부)
    alb.ingress.kubernetes.io/scheme: internet-facing

    # 타겟 타입:
    # - ip: Pod IP 직접 타겟팅 (권장, ENI 사용)
    # - instance: NodePort를 통한 라우팅
    alb.ingress.kubernetes.io/target-type: ip

    # ==========================================================================
    # 리스너 및 SSL 설정
    # ==========================================================================

    # 리스너 포트 설정
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'

    # HTTP -> HTTPS 리다이렉트
    alb.ingress.kubernetes.io/ssl-redirect: "443"

    # ACM 인증서 ARN (실제 인증서 ARN으로 변경 필요)
    # alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-northeast-2:123456789012:certificate/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx

    # SSL 정책
    alb.ingress.kubernetes.io/ssl-policy: ELBSecurityPolicy-TLS13-1-2-2021-06

    # ==========================================================================
    # Health Check 설정 (Spring Boot Actuator 연동)
    # ==========================================================================

    # 헬스체크 경로 (Spring Boot Actuator)
    alb.ingress.kubernetes.io/healthcheck-path: /actuator/health

    # 헬스체크 프로토콜
    alb.ingress.kubernetes.io/healthcheck-protocol: HTTP

    # 헬스체크 포트 (traffic-port = 타겟 포트 사용)
    alb.ingress.kubernetes.io/healthcheck-port: traffic-port

    # 헬스체크 간격 (초)
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: "15"

    # 헬스체크 타임아웃 (초)
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: "5"

    # 정상 판정 횟수
    alb.ingress.kubernetes.io/healthy-threshold-count: "2"

    # 비정상 판정 횟수
    alb.ingress.kubernetes.io/unhealthy-threshold-count: "2"

    # 성공 코드 (Spring Boot Actuator는 200 반환)
    alb.ingress.kubernetes.io/success-codes: "200"

    # ==========================================================================
    # 성능 및 보안 설정
    # ==========================================================================

    # 유휴 타임아웃 (초) - WebSocket 사용 시 늘려야 함
    alb.ingress.kubernetes.io/load-balancer-attributes: idle_timeout.timeout_seconds=60

    # WAF 연동 (선택사항)
    # alb.ingress.kubernetes.io/waf-acl-id: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx

    # 액세스 로그 활성화 (선택사항)
    # alb.ingress.kubernetes.io/load-balancer-attributes: access_logs.s3.enabled=true,access_logs.s3.bucket=my-access-logs-bucket,access_logs.s3.prefix=alb-logs

    # ==========================================================================
    # 태그 설정
    # ==========================================================================

    # ALB에 추가할 태그
    alb.ingress.kubernetes.io/tags: Environment=production,Team=backend,Application=open-green

spec:
  # Ingress 클래스 (Kubernetes 1.18+)
  ingressClassName: alb

  rules:
    # ==========================================================================
    # 메인 도메인 라우팅
    # ==========================================================================
    - host: open-green.example.com  # 실제 도메인으로 변경 필요
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: open-green-service
                port:
                  number: 80

    # ==========================================================================
    # API 서브도메인 (선택사항)
    # ==========================================================================
    - host: api.open-green.example.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: open-green-service
                port:
                  number: 80

---
# ============================================================================
# 로컬 개발용 Ingress (Kind, Minikube 환경)
# ============================================================================
# 로컬 환경에서는 AWS ALB를 사용할 수 없으므로 Nginx Ingress 사용
# 이 설정은 로컬 테스트 전용입니다.
#
# 활성화 방법:
# 1. Kind/Minikube에 nginx-ingress-controller 설치
# 2. /etc/hosts에 127.0.0.1 open-green.local 추가
# ============================================================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: open-green-ingress-local
  namespace: default
  labels:
    app: open-green
    environment: local
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    # WebSocket 지원
    nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
spec:
  ingressClassName: nginx
  rules:
    - host: open-green.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: open-green-service
                port:
                  number: 80

# ============================================================================
# AWS ALB vs Nginx Ingress 비교
# ============================================================================
#
# AWS ALB Ingress Controller:
#   트래픽 흐름: Route53 -> ALB (L7) -> Pod
#   장점:
#     - L7 처리 1회 (성능 최적)
#     - AWS 서비스 통합 (WAF, Cognito, ACM)
#     - 관리형 서비스 (고가용성)
#     - target-type: ip 사용 시 Service 우회 가능
#   단점:
#     - AWS 종속
#     - 로컬 개발 환경에서 사용 불가
#
# Nginx Ingress Controller:
#   트래픽 흐름: Route53 -> NLB (L4) -> Nginx Pod (L7) -> Service -> Pod
#   장점:
#     - 클라우드 독립적
#     - 로컬 환경에서도 동일하게 사용
#     - 세밀한 설정 가능
#   단점:
#     - Nginx Pod 관리 필요
#     - 추가 리소스 소비
#
# ============================================================================
# 사용 명령어
# ============================================================================
#
# 1. Ingress 적용:
#    kubectl apply -f ingress.yaml
#
# 2. Ingress 상태 확인:
#    kubectl get ingress
#    kubectl describe ingress open-green-ingress
#
# 3. ALB 프로비저닝 확인:
#    kubectl get ingress open-green-ingress -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
#
# 4. ALB DNS 확인 후 Route53에 CNAME 또는 Alias 레코드 생성
#
# 5. AWS 콘솔에서 ALB 상태 확인:
#    EC2 > Load Balancers
#
# ============================================================================
