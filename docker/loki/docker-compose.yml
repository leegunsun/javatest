# =============================================================================
# open-green Loki Stack - Local Development
# =============================================================================
# ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš© Loki + Promtail + Grafana ìŠ¤íƒ
#
# ğŸ”— ì „ì²´ ì•„í‚¤í…ì²˜:
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚  Spring Boot    â”‚ --> â”‚   Log Files  â”‚ --> â”‚  Promtail   â”‚ --> â”‚    Loki      â”‚
#   â”‚  Application    â”‚     â”‚  (./logs/)   â”‚     â”‚  (ìˆ˜ì§‘ê¸°)    â”‚     â”‚  (ì €ì¥ì†Œ)    â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#                                                                            â”‚
#                                                                            â–¼
#                                                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#                                                                     â”‚   Grafana    â”‚
#                                                                     â”‚  (ì‹œê°í™”)    â”‚
#                                                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# ì‹¤í–‰ ë°©ë²•:
#   cd docker/loki
#   docker-compose up -d
#
# ì ‘ì† URL:
#   - Grafana: http://localhost:3001 (admin/admin)
#   - Loki API: http://localhost:3100
#   - Promtail: http://localhost:9080
#
# ì¢…ë£Œ ë°©ë²•:
#   docker-compose down
#   docker-compose down -v  # ë°ì´í„° ë³¼ë¥¨ê¹Œì§€ ì‚­ì œ
# =============================================================================

version: "3.8"

# =============================================================================
# ğŸŒ ë„¤íŠ¸ì›Œí¬ ì„¤ì •
# =============================================================================
# Docker ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ ì •ì˜ - ì»¨í…Œì´ë„ˆ ê°„ í†µì‹ ì— ì‚¬ìš©
networks:
  loki-network:
    # bridge: ê¸°ë³¸ Docker ë„¤íŠ¸ì›Œí¬ ë“œë¼ì´ë²„
    # - ê°™ì€ ë„¤íŠ¸ì›Œí¬ ë‚´ ì»¨í…Œì´ë„ˆë¼ë¦¬ ì„œë¹„ìŠ¤ ì´ë¦„ìœ¼ë¡œ í†µì‹  ê°€ëŠ¥
    # - ì˜ˆ: Promtailì—ì„œ 'loki:3100'ìœ¼ë¡œ Loki ì ‘ê·¼
    # ğŸ”— [Loki-Promtail ì—°ê´€]: ì´ ë„¤íŠ¸ì›Œí¬ë¥¼ í†µí•´ Promtail â†’ Loki í†µì‹ 
    driver: bridge

# =============================================================================
# ğŸ’¾ ë³¼ë¥¨ ì„¤ì • (ë°ì´í„° ì˜ì†í™”)
# =============================================================================
# Docker ê´€ë¦¬ ë³¼ë¥¨ ì •ì˜ - ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ ì‹œì—ë„ ë°ì´í„° ìœ ì§€
volumes:
  # Loki ë°ì´í„° ë³¼ë¥¨
  # - ë¡œê·¸ ì²­í¬, ì¸ë±ìŠ¤, WAL ë“± ì €ì¥
  # ğŸ”— [Loki ì—°ê´€]: loki-config.ymlì˜ path_prefix(/loki)ì™€ ë§¤í•‘ë¨
  loki-data:

  # Grafana ë°ì´í„° ë³¼ë¥¨
  # - ëŒ€ì‹œë³´ë“œ, ì‚¬ìš©ì ì„¤ì •, í”ŒëŸ¬ê·¸ì¸ ë“± ì €ì¥
  grafana-data:

# =============================================================================
# ğŸ³ ì„œë¹„ìŠ¤ ì •ì˜
# =============================================================================
services:

  # ===========================================================================
  # ğŸ“¦ Loki - ë¡œê·¸ ì €ì¥ ë° ì¿¼ë¦¬ ì—”ì§„
  # ===========================================================================
  # Loki: Grafana Labsì˜ ë¡œê·¸ ì§‘ê³„ ì‹œìŠ¤í…œ
  # - Prometheusì—ì„œ ì˜ê°ì„ ë°›ì€ ë¼ë²¨ ê¸°ë°˜ ë¡œê·¸ ì €ì¥
  # - ë¡œê·¸ ë³¸ë¬¸ì€ ì¸ë±ì‹±í•˜ì§€ ì•Šì•„ ë¹„ìš© íš¨ìœ¨ì 
  # ğŸ”— [Promtail ì—°ê´€ - í•µì‹¬]: Promtailì˜ ëŒ€ìƒ ì„œë²„
  #    - promtail-config.ymlì˜ clients.urlì—ì„œ ì´ ì„œë¹„ìŠ¤ë¡œ ì—°ê²°
  loki:
    # ê³µì‹ Grafana Loki ì´ë¯¸ì§€
    # - ë²„ì „ ê³ ì •ìœ¼ë¡œ ì˜ˆì¸¡ ê°€ëŠ¥í•œ ë™ì‘ ë³´ì¥
    image: grafana/loki:2.9.2

    # ì»¨í…Œì´ë„ˆ ì´ë¦„ (docker psì—ì„œ í‘œì‹œ)
    container_name: open-green-loki

    # í¬íŠ¸ ë§¤í•‘ (í˜¸ìŠ¤íŠ¸:ì»¨í…Œì´ë„ˆ)
    ports:
      # HTTP API í¬íŠ¸
      # ğŸ”— [Promtail ì—°ê´€ - í•µì‹¬]: promtail-config.ymlì˜ clients.url í¬íŠ¸ì™€ ì¼ì¹˜
      # ğŸ”— [Grafana ì—°ê´€]: Grafana ë°ì´í„°ì†ŒìŠ¤ URL í¬íŠ¸ì™€ ì¼ì¹˜
      # ğŸ”— [loki-config.yml ì—°ê´€]: server.http_listen_port(3100)ì™€ ì¼ì¹˜
      - "3100:3100"

      # gRPC í¬íŠ¸ (Loki ë‚´ë¶€ í†µì‹ ìš©)
      # ğŸ”— [loki-config.yml ì—°ê´€]: server.grpc_listen_port(9096)ì™€ ì¼ì¹˜
      - "9096:9096"

    # ë³¼ë¥¨ ë§ˆìš´íŠ¸
    volumes:
      # Loki ì„¤ì • íŒŒì¼ ë§ˆìš´íŠ¸
      # - :ro = read-only (ì»¨í…Œì´ë„ˆì—ì„œ ìˆ˜ì • ë¶ˆê°€)
      # ğŸ”— [loki-config.yml ì—°ê´€]: ì´ ì„¤ì • íŒŒì¼ì´ Lokiì— ì ìš©ë¨
      - ./loki-config.yml:/etc/loki/local-config.yaml:ro

      # ë°ì´í„° ë³¼ë¥¨ ë§ˆìš´íŠ¸
      # ğŸ”— [loki-config.yml ì—°ê´€]: path_prefix(/loki) ê²½ë¡œì— ë§¤í•‘
      #    - /loki/chunks: ë¡œê·¸ ì²­í¬ ì €ì¥
      #    - /loki/wal: Write-Ahead Log
      #    - /loki/tsdb-index: TSDB ì¸ë±ìŠ¤
      - loki-data:/loki

    # ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹œ ì‹¤í–‰í•  ëª…ë ¹
    # ğŸ”— [loki-config.yml ì—°ê´€]: ì„¤ì • íŒŒì¼ ê²½ë¡œ ì§€ì •
    command: -config.file=/etc/loki/local-config.yaml

    # ì¬ì‹œì‘ ì •ì±…
    # - unless-stopped: ìˆ˜ë™ ì¤‘ì§€ ì „ê¹Œì§€ ìë™ ì¬ì‹œì‘
    restart: unless-stopped

    # ë„¤íŠ¸ì›Œí¬ ì—°ê²°
    # ğŸ”— [Promtail ì—°ê´€]: ê°™ì€ ë„¤íŠ¸ì›Œí¬ì—ì„œ 'loki' ì´ë¦„ìœ¼ë¡œ ì ‘ê·¼ ê°€ëŠ¥
    networks:
      - loki-network

    # í—¬ìŠ¤ì²´í¬ ì„¤ì • (ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸)
    # - Promtailê³¼ Grafanaì˜ depends_on ì¡°ê±´ì— ì‚¬ìš©ë¨
    healthcheck:
      # Lokiì˜ /ready ì—”ë“œí¬ì¸íŠ¸ë¡œ ì¤€ë¹„ ìƒíƒœ í™•ì¸
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1"]

      # ì²´í¬ ê°„ê²©
      interval: 10s

      # ì‘ë‹µ ëŒ€ê¸° ì‹œê°„
      timeout: 5s

      # ì‹¤íŒ¨ í—ˆìš© íšŸìˆ˜ (ì´í›„ unhealthy ìƒíƒœ)
      retries: 5

    # ì»¨í…Œì´ë„ˆ ë¡œê¹… ì„¤ì •
    # - Loki ìì²´ì˜ ë¡œê·¸ë¥¼ Docker json-fileë¡œ ê´€ë¦¬
    logging:
      driver: json-file
      options:
        # ë¡œê·¸ íŒŒì¼ ìµœëŒ€ í¬ê¸°
        max-size: "10m"
        # ë¡œê·¸ íŒŒì¼ ìµœëŒ€ ê°œìˆ˜ (ë¡œí…Œì´ì…˜)
        max-file: "3"

  # ===========================================================================
  # ğŸ“¡ Promtail - ë¡œê·¸ ìˆ˜ì§‘ ì—ì´ì „íŠ¸
  # ===========================================================================
  # Promtail: Lokiìš© ë¡œê·¸ ìˆ˜ì§‘ ì—ì´ì „íŠ¸
  # - ë¡œê·¸ íŒŒì¼ì„ ëª¨ë‹ˆí„°ë§í•˜ê³  Lokië¡œ ì „ì†¡
  # - ë¼ë²¨ ì¶”ê°€, ë¡œê·¸ íŒŒì‹±, í•„í„°ë§ ë“± ì „ì²˜ë¦¬ ìˆ˜í–‰
  # ğŸ”— [Loki ì—°ê´€ - í•µì‹¬]: Lokiì— ë¡œê·¸ë¥¼ ì „ì†¡í•˜ëŠ” í´ë¼ì´ì–¸íŠ¸
  promtail:
    # ê³µì‹ Grafana Promtail ì´ë¯¸ì§€
    # - Lokiì™€ ê°™ì€ ë²„ì „ ì‚¬ìš© ê¶Œì¥ (í˜¸í™˜ì„±)
    # ğŸ”— [Loki ì—°ê´€]: Loki ì´ë¯¸ì§€ ë²„ì „(2.9.2)ê³¼ ì¼ì¹˜
    image: grafana/promtail:2.9.2

    container_name: open-green-promtail

    # í¬íŠ¸ ë§¤í•‘
    ports:
      # Promtail HTTP API í¬íŠ¸
      # - /ready: ì¤€ë¹„ ìƒíƒœ í™•ì¸
      # - /metrics: Prometheus ë©”íŠ¸ë¦­
      # - /targets: ìˆ˜ì§‘ ëŒ€ìƒ ìƒíƒœ
      # ğŸ”— [promtail-config.yml ì—°ê´€]: server.http_listen_port(9080)ì™€ ì¼ì¹˜
      - "9080:9080"

    # ë³¼ë¥¨ ë§ˆìš´íŠ¸
    volumes:
      # Promtail ì„¤ì • íŒŒì¼
      # ğŸ”— [promtail-config.yml ì—°ê´€]: ì´ ì„¤ì • íŒŒì¼ì´ Promtailì— ì ìš©ë¨
      - ./promtail-config.yml:/etc/promtail/config.yml:ro

      # Spring Boot ë¡œê·¸ ë””ë ‰í† ë¦¬ ë§ˆìš´íŠ¸ (í•µì‹¬!)
      # - ../../logs: í”„ë¡œì íŠ¸ ë£¨íŠ¸ì˜ logs ë””ë ‰í† ë¦¬
      # - /var/log/open-green: ì»¨í…Œì´ë„ˆ ë‚´ ê²½ë¡œ
      # - :ro = read-only (Promtailì€ ë¡œê·¸ë¥¼ ì½ê¸°ë§Œ í•¨)
      # ğŸ”— [promtail-config.yml ì—°ê´€ - í•µì‹¬]:
      #    - scrape_configsì˜ __path__ ì„¤ì •ê³¼ ì¼ì¹˜í•´ì•¼ í•¨
      #    - /var/log/open-green/appLogs/*.json
      #    - /var/log/open-green/errorLogs/*.json
      #    - /var/log/open-green/*.log
      # ğŸ”— [Spring Boot ì—°ê´€]: application.ymlì˜ logging.file.pathì™€ ì¼ì¹˜
      - ../../logs:/var/log/open-green:ro  # Spring Boot ë¡œê·¸ ë””ë ‰í† ë¦¬ ë§ˆìš´íŠ¸

    # Promtail ì‹œì‘ ëª…ë ¹
    # ğŸ”— [promtail-config.yml ì—°ê´€]: ì„¤ì • íŒŒì¼ ê²½ë¡œ ì§€ì •
    command: -config.file=/etc/promtail/config.yml

    restart: unless-stopped

    # ë„¤íŠ¸ì›Œí¬ ì—°ê²°
    # ğŸ”— [Loki ì—°ê´€ - í•µì‹¬]: ê°™ì€ ë„¤íŠ¸ì›Œí¬ì—ì„œ 'loki'ë¡œ Loki ì„œë²„ ì ‘ê·¼
    #    - promtail-config.ymlì˜ http://loki:3100 ì´ ë™ì‘í•˜ë ¤ë©´ í•„ìˆ˜
    networks:
      - loki-network

    # ì„œë¹„ìŠ¤ ì˜ì¡´ì„±
    # ğŸ”— [Loki ì—°ê´€ - í•µì‹¬]: Lokiê°€ ì¤€ë¹„ëœ í›„ì— Promtail ì‹œì‘
    #    - service_healthy: Lokiì˜ healthcheck í†µê³¼ í›„ ì‹œì‘
    #    - Loki ì—†ì´ Promtailì´ ì‹œì‘ë˜ë©´ ë¡œê·¸ ì „ì†¡ ì‹¤íŒ¨
    depends_on:
      loki:
        condition: service_healthy

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================================================
  # ğŸ“Š Grafana - ì‹œê°í™” ëŒ€ì‹œë³´ë“œ
  # ===========================================================================
  # Grafana: ì˜¤í”ˆì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§ ë° ì‹œê°í™” í”Œë«í¼
  # - Lokiì˜ ë¡œê·¸ë¥¼ ì‹œê°í™”í•˜ê³  ì¿¼ë¦¬
  # - ëŒ€ì‹œë³´ë“œ, ì•Œë¦¼, íƒìƒ‰ ê¸°ëŠ¥ ì œê³µ
  # ğŸ”— [Loki ì—°ê´€]: Lokië¥¼ ë°ì´í„°ì†ŒìŠ¤ë¡œ ì‚¬ìš©í•˜ì—¬ ë¡œê·¸ ì¡°íšŒ
  grafana:
    # ê³µì‹ Grafana ì´ë¯¸ì§€
    image: grafana/grafana:10.2.2

    container_name: open-green-grafana

    # í¬íŠ¸ ë§¤í•‘
    ports:
      # Grafana ì›¹ UI í¬íŠ¸
      # - 3001:3000 = í˜¸ìŠ¤íŠ¸ì˜ 3001ì„ ì»¨í…Œì´ë„ˆì˜ 3000ì— ë§¤í•‘
      # - 3000ì€ Grafana ê¸°ë³¸ í¬íŠ¸ (í˜¸ìŠ¤íŠ¸ì˜ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ì™€ ì¶©ëŒ ë°©ì§€)
      - "3001:3000"

    # ë³¼ë¥¨ ë§ˆìš´íŠ¸
    volumes:
      # Grafana ë°ì´í„° (ëŒ€ì‹œë³´ë“œ, ì„¤ì • ë“±) ì˜ì†í™”
      - grafana-data:/var/lib/grafana

      # ìë™ í”„ë¡œë¹„ì €ë‹ ì„¤ì •
      # - ë°ì´í„°ì†ŒìŠ¤, ëŒ€ì‹œë³´ë“œ ë“±ì„ ìë™ìœ¼ë¡œ ì„¤ì •
      # ğŸ”— [Loki ì—°ê´€]: provisioning/datasources/loki.ymlì—ì„œ Loki ë°ì´í„°ì†ŒìŠ¤ ìë™ ë“±ë¡
      - ./provisioning:/etc/grafana/provisioning:ro

    # í™˜ê²½ ë³€ìˆ˜ (Grafana ì„¤ì •)
    environment:
      # ê´€ë¦¬ì ê³„ì • ì‚¬ìš©ìëª…
      - GF_SECURITY_ADMIN_USER=admin

      # ê´€ë¦¬ì ê³„ì • ë¹„ë°€ë²ˆí˜¸ (ë¡œì»¬ ê°œë°œìš© - í”„ë¡œë•ì…˜ì—ì„œëŠ” ë³€ê²½ í•„ìˆ˜!)
      - GF_SECURITY_ADMIN_PASSWORD=admin

      # íšŒì›ê°€ì… ë¹„í™œì„±í™”
      - GF_USERS_ALLOW_SIGN_UP=false

      # ìµëª… ì ‘ê·¼ í—ˆìš© (ì½ê¸° ì „ìš©)
      # - ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ì„œ í¸ì˜ë¥¼ ìœ„í•´ í™œì„±í™”
      - GF_AUTH_ANONYMOUS_ENABLED=true

      # ìµëª… ì‚¬ìš©ì ì—­í•  (Viewer = ì½ê¸°ë§Œ ê°€ëŠ¥)
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer

    restart: unless-stopped

    # ë„¤íŠ¸ì›Œí¬ ì—°ê²°
    # ğŸ”— [Loki ì—°ê´€]: ê°™ì€ ë„¤íŠ¸ì›Œí¬ì—ì„œ 'loki'ë¡œ Loki ì„œë²„ ì ‘ê·¼
    #    - ë°ì´í„°ì†ŒìŠ¤ URL: http://loki:3100
    networks:
      - loki-network

    # ì„œë¹„ìŠ¤ ì˜ì¡´ì„±
    # ğŸ”— [Loki ì—°ê´€]: Lokiê°€ ì¤€ë¹„ëœ í›„ì— Grafana ì‹œì‘
    depends_on:
      loki:
        condition: service_healthy

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
