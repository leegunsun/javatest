import groovy.json.JsonOutput

def baseDir = file('src/main/java/com/example/open/domain')
def outputFile = file('src/main/resources/static/swagger-status/api-meta.json')


task generateApiMeta {
    group = 'build setup'
    description = 'Git blame ê¸°ë°˜ìœ¼ë¡œ Swaggerìš© api-meta.json ìƒì„±'

    outputs.file(outputFile)

    doLast {
        if (!baseDir.exists()) {
            println "âš ï¸  baseDir ê²½ë¡œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: ${baseDir}"
            outputFile.text = "{}"
            return
        }

        def metaMap = [:]

        baseDir.eachDirRecurse { subDir ->
            if (subDir.name == "controller") {
                println "ğŸ“‚ controller ë””ë ‰í„°ë¦¬ íƒìƒ‰ ì¤‘: ${subDir}"

                subDir.eachFileRecurse { file ->
                    if (file.name.endsWith('.java')) {
                        def className = file.absolutePath
                                .replace(project.projectDir.absolutePath + File.separator + "src${File.separator}main${File.separator}java${File.separator}", "")
                                .replaceAll("[/\\\\]", ".") // ëª¨ë“  OS í˜¸í™˜
                                .replace(".java", "")

                        def lines = file.readLines()

                        def pendingOperation = false
                        def operationSummaryLine = -1
                        def storedMethodName = null

                        def startLine = -1

                        lines.eachWithIndex { line, i ->
                            if (line.contains("@Operation")) {
                                pendingOperation = true
                                startLine = i  // @Operation ì‹œì‘ ì¤„ ì €ì¥
                            }

                            if (pendingOperation && (line.contains("summary") || line.contains("description"))) {
                                operationSummaryLine = i  // summary ì¤„ ì €ì¥
                            }

                            def methodMatcher = line =~ /public\s+[\w<>\[\],\s]+?\s+(\w+)\s*\(/
                            if (pendingOperation && methodMatcher && startLine >= 0) {
                                storedMethodName = methodMatcher[0][1]

                                def endLine = i + 1  // 0-based ì¸ë±ìŠ¤ iì— +1ì„ í•´ì„œ ì‹¤ì œ íŒŒì¼ì˜ í–‰ ë²ˆí˜¸
                                def blame = "git blame -L ${startLine+1},${endLine} ${file.absolutePath}".execute().text
//                                println "DEBUG-NEW: file=${file.name}, start=${startLine+1}, end=${endLine}"
                                def dateMatch = (blame =~ /(\d{4}-\d{2}-\d{2})/)
                                def allDates = dateMatch.collect { it[1] }
                                def date = allDates ? allDates.sort().last() : 'unknown'

                                def key = "${className}#${storedMethodName}"
                                if (!metaMap.containsKey(key)) {
                                    metaMap[key] = date
                                }

                                // ì´ˆê¸°í™”
                                pendingOperation = false
                                operationSummaryLine = -1
                                startLine = -1
                                storedMethodName = null
                            }
                        }

                    }
                }
            }
        }

        outputFile.text = JsonOutput.prettyPrint(JsonOutput.toJson(metaMap))
        println "âœ… api-meta.json ìƒì„± ì™„ë£Œ: ${outputFile.absolutePath}"
    }
}