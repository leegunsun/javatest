version: '3'
services:
  # ============================================================
  # KRaft 모드 Kafka (ZooKeeper 없음)
  # ============================================================
  #
  # KRaft (Kafka Raft) 모드:
  # - ZooKeeper 의존성 제거
  # - 메타데이터를 Kafka 자체에서 관리
  # - 단순화된 아키텍처와 빠른 복구
  #
  kafka:
    image: apache/kafka:3.7.0
    container_name: kafka-kraft
    ports:
      - "9092:9092"   # 클라이언트 연결용
      - "9093:9093"   # 컨트롤러 통신용
    environment:
      # ============================================================
      # KRaft 핵심 설정
      # ============================================================
      # NODE_ID: 클러스터 내 고유 노드 식별자
      KAFKA_NODE_ID: 1

      # PROCESS_ROLES: broker(메시지 처리), controller(클러스터 관리)
      # 단일 노드에서는 둘 다 수행
      KAFKA_PROCESS_ROLES: broker,controller

      # CONTROLLER_QUORUM_VOTERS: 컨트롤러 노드 목록
      # 형식: {node_id}@{host}:{port}
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093

      # ============================================================
      # 리스너 설정
      # ============================================================
      # LISTENERS: Kafka가 수신 대기하는 주소
      # - INTERNAL: Docker 네트워크 내부용 (kafka-ui 등)
      # - EXTERNAL: 호스트 머신에서 접근용 (Spring Boot 앱 등)
      KAFKA_LISTENERS: INTERNAL://0.0.0.0:29092,EXTERNAL://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093

      # ADVERTISED_LISTENERS: 클라이언트에게 알려주는 주소
      # - INTERNAL: Docker 컨테이너들이 사용
      # - EXTERNAL: 호스트에서 localhost로 접근
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka:29092,EXTERNAL://localhost:9092

      # 보안 프로토콜 매핑
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL

      # ============================================================
      # 클러스터 설정
      # ============================================================
      # CLUSTER_ID: 클러스터 고유 식별자 (Base64 인코딩)
      CLUSTER_ID: MkU3OEVBNTcwNTJENDM2Qk

      # ============================================================
      # 토픽 복제 설정 (단일 노드용)
      # ============================================================
      # 단일 노드이므로 replication-factor는 1
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1

      # ============================================================
      # 토픽 자동 생성
      # ============================================================
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"

      # 기본 파티션 수 (자동 생성 시)
      KAFKA_NUM_PARTITIONS: 3

      # ============================================================
      # 로그 설정
      # ============================================================
      KAFKA_LOG_DIRS: /var/lib/kafka/data

      # 로그 보존 기간 (1시간 - 테스트용)
      KAFKA_LOG_RETENTION_HOURS: 1

    volumes:
      - kafka-data:/var/lib/kafka/data
    networks:
      - kafka_network
    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server localhost:9092 || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5

  # Kafka UI (선택사항 - 모니터링용)
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    ports:
      - "8080:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: kraft-cluster
      # 내부 리스너(29092)를 사용하여 Docker 네트워크 내에서 연결
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
    depends_on:
      - kafka
    networks:
      - kafka_network

volumes:
  kafka-data:

networks:
  kafka_network:
    driver: bridge
